rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ======================================================
    // SECURITY HELPERS
    // ======================================================
    
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user is an active admin in the new system
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isActive == true;
    }

    // Check if user is a super admin
    function isSuperAdmin() {
      return isAuthenticated() && (
        request.auth.token.email == 'batchcrick@gmail.com' || (
          exists(/databases/$(database)/documents/admins/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super_admin'
        )
      );
    }

    // Check if the current user owns the document via adminId
    function isOwner(data) {
      return isAuthenticated() && (data.adminId == request.auth.uid || isSuperAdmin());
    }

    // Legacy admin check
    function isLegacyAdmin() {
      return isAuthenticated() && (
        exists(/databases/$(database)/documents/admin/$(request.auth.uid)) ||
        (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'super_admin']) ||
        request.auth.token.email == 'batchcrick@gmail.com'
      );
    }

    // Combined admin check (prefers new system)
    function isAnyAdmin() {
      return isAdmin() || isLegacyAdmin();
    }

    // ======================================================
    // ADMIN IDENTITY & OWNERSHIP
    // ======================================================

    match /admins/{adminId} {
      // Admins can read their own profile, Super Admins can read all
      allow read: if isAuthenticated() && (request.auth.uid == adminId || isSuperAdmin());
      
      // Allow Super Admin to create any admin (including themselves)
      allow create: if isSuperAdmin();
                    
      // Only super admin can activate or change roles
      allow update: if isSuperAdmin() || (isAdmin() && request.auth.uid == adminId && 
                    !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isActive']));
                    
      allow delete: if isSuperAdmin();
    }

    match /invited_admins/{email} {
      // Allow read for the person being invited (to check during login) or any Super Admin
      allow read: if isAuthenticated() && (request.auth.token.email.lower() == email.lower() || isSuperAdmin());
      // Only Super Admin can invite/delete invites
      allow write: if isSuperAdmin();
    }

    // ======================================================
    // CORE DATA COLLECTIONS (Public Read, Admin Write)
    // ======================================================

    match /tournaments/{id} {
      allow read: if true;
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isAdmin() && isOwner(resource.data);
    }

    match /matches/{matchId} {
      allow read: if true;
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isAdmin() && isOwner(resource.data);
      
      match /commentary/{id} {
        allow read: if true;
        allow write: if isAdmin() && isOwner(get(/databases/$(database)/documents/matches/$(matchId)).data);
      }
      
      match /innings/{inningId} {
        allow read: if true;
        allow write: if isAdmin() && isOwner(get(/databases/$(database)/documents/matches/$(matchId)).data);

        match /balls/{ballId} {
          allow read: if true;
          allow write: if isAdmin() && isOwner(get(/databases/$(database)/documents/matches/$(matchId)).data);
        }
      }
    }

    match /squads/{id} {
      allow read: if true;
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isAdmin() && isOwner(resource.data);
    }

    match /players/{playerId} {
      allow read: if true;
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow delete: if isAdmin() && isOwner(resource.data);
      
      allow update: if (isAdmin() && isOwner(resource.data)) || (
        // Player self-update (claim logic) - MUST NOT allow changing adminId
        isAuthenticated() && (
          (request.resource.data.diff(resource.data).affectedKeys().hasAny(['lastVerifiedAt']) &&
           request.resource.data.claimed == true && 
           request.resource.data.ownerUid == request.auth.uid &&
           request.auth.token.email.lower() == get(/databases/$(database)/documents/player_secrets/$(playerId)).data.email.lower() &&
           request.resource.data.diff(resource.data).affectedKeys().hasOnly(['claimed', 'ownerUid', 'lastVerifiedAt', 'updatedAt'])) ||
          (resource.data.ownerUid == request.auth.uid && 
           request.time < resource.data.lastVerifiedAt + duration.value(1, 'h') &&
           !request.resource.data.diff(resource.data).affectedKeys().hasAny(['id', 'squadId', 'batch', 'school', 'claimed', 'ownerUid', 'lastVerifiedAt', 'email', 'maskedEmail', 'createdAt', 'createdBy', 'adminId']))
        )
      );
    }

    // ======================================================
    // PRIVATE DATA & SETTINGS
    // ======================================================

    match /notifications/{id} {
      allow read, write: if isAdmin() && (isOwner(resource.data) || request.resource.data.adminId == request.auth.uid);
    }

    match /settings/{id} {
      allow read, write: if isAdmin() && (isOwner(resource.data) || request.resource.data.adminId == request.auth.uid);
    }

    match /player_secrets/{playerId} {
      // Only allow reading if it's an admin of the record OR the user is claiming their own
      allow read: if isAuthenticated() && (
        (isAdmin() && isOwner(get(/databases/$(database)/documents/players/$(playerId)).data)) || 
        request.auth.token.email.lower() == resource.data.email.lower()
      );
      allow write: if isAdmin() && isOwner(get(/databases/$(database)/documents/players/$(playerId)).data);
    }

    match /playerMatchStats/{statId} {
      allow read: if true;
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isAdmin() && isOwner(resource.data);
    }

    // ======================================================
    // SYSTEM & LOGS
    // ======================================================

    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
    }

    match /permitted_admins/{email} {
      allow read: if isAuthenticated() && (isAnyAdmin() || request.auth.token.email.lower() == email.lower());
      allow write: if isSuperAdmin();
    }

    match /champions/{id} {
      allow read: if true;
      allow create: if isAdmin() && request.resource.data.adminId == request.auth.uid;
      allow update, delete: if isAdmin() && isOwner(resource.data);
    }

    // LEGACY: Old admin collection (should be migrated)
    match /admin/{adminId} {
      allow read: if isAuthenticated() && request.auth.uid == adminId;
      allow write: if false; // Block new writes to legacy collection
    }

    match /email_logs/{logId} {
      allow read: if isSuperAdmin();
      allow create: if isAdmin() || isSuperAdmin();
    }
  }
}
